<svg host="65bd71144e" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" width="4502px" height="2261px" viewBox="-0.5 -0.5 4502 2261" content="&lt;mxfile&gt;&lt;diagram id=&quot;3KwbdyD06HSjcGMrvIiw&quot; name=&quot;Page-1&quot;&gt;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&lt;/diagram&gt;&lt;/mxfile&gt;">
    <defs/>
    <g>
        <path d="M 3111 370 L 3361 370 L 3361 557 Q 3298.5 497.6 3236 557 Q 3173.5 616.4 3111 557 L 3111 403 Z" fill="rgb(255, 255, 255)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 248px; height: 1px; padding-top: 447px; margin-left: 3112px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#9cdcfe">
                                    dim = 4096
                                    <br/>
                                    n_layers  =32
                                    <br/>
                                    n_heads = 32
                                    <br/>
                                    n_heads_kv = Optional
                                    <br/>
                                    <br/>
                                    multiple_of = 256
                                    <br/>
                                    ffn_dim_multiplier = Optional
                                    <br/>
                                    <br/>
                                    max_batch_size = 32
                                    <br/>
                                    max_seq_len = 2048
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3236" y="451" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    dim = 4096...
                </text>
            </switch>
        </g>
        <rect x="2980" y="440" width="170" height="40" fill="#333333" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <path d="M 2997 440 L 2997 480 M 3133 440 L 3133 480" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 134px; height: 1px; padding-top: 460px; margin-left: 2998px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <span style="color: rgb(156, 220, 254);">
                                    (hidden dim of FF layer)
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3065" y="464" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    (hidden dim of FF lay...
                </text>
            </switch>
        </g>
        <rect x="2980" y="490" width="170" height="40" fill="#333333" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <path d="M 2997 490 L 2997 530 M 3133 490 L 3133 530" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 134px; height: 1px; padding-top: 510px; margin-left: 2998px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <span style="color: rgb(156, 220, 254);">
                                    For KV cache
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3065" y="514" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    For KV cache
                </text>
            </switch>
        </g>
        <path d="M 2990 670 L 3130 670 L 3150 720 L 3130 770 L 2990 770 L 2970 720 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 720px; margin-left: 2971px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        TRANSFORMER
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="724" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    TRANSFORMER
                </text>
            </switch>
        </g>
        <path d="M 3100 240 L 3240 240 L 3260 290 L 3240 340 L 3100 340 L 3080 290 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 290px; margin-left: 3081px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        Model Args
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3170" y="294" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Model Args
                </text>
            </switch>
        </g>
        <path d="M 2800 960 L 2903.63 960" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2908.88 960 L 2901.88 963.5 L 2903.63 960 L 2901.88 956.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2550" y="930" width="250" height="60" fill="#ffcce6" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 248px; height: 1px; padding-top: 960px; margin-left: 2551px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                tok_embds
                                <br/>
                                <i>
                                    nn.Embd(vocab_size, dim)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2675" y="965" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    tok_embds...
                </text>
            </switch>
        </g>
        <path d="M 2830 1160 L 2878.63 1160" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2883.88 1160 L 2876.88 1163.5 L 2878.63 1160 L 2876.88 1156.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 2570 1145 L 2015.12 1556.21" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2010.9 1559.33 L 2014.44 1552.35 L 2015.12 1556.21 L 2018.61 1557.98 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1400px; margin-left: 2201px;">
                        <div data-drawio-colors="color: #E6E6E6; background-color: rgb(255, 255, 255); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 24px; font-family: Helvetica; color: rgb(230, 230, 230); line-height: 1.2; pointer-events: all; background-color: rgb(255, 255, 255); white-space: nowrap;">
                                <font color="#1a1a1a" style="">
                                    <font style="background-color: rgb(240, 240, 240); font-size: 14px;">
                                        forward method
                                        <i style="">
                                            <b style="">
                                                (x, start_pos, freqs_complex)
                                            </b>
                                        </i>
                                    </font>
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2201" y="1408" fill="#E6E6E6" font-family="Helvetica" font-size="24px" text-anchor="middle">
                    forward method (x, start_pos, freqs_complex)
                </text>
            </switch>
        </g>
        <rect x="2570" y="1130" width="260" height="60" fill="#ffcce6" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 258px; height: 1px; padding-top: 1160px; margin-left: 2571px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                layers (n_layers times)
                                <br/>
                                <i>
                                    <b>
                                        EncoderBlock
                                    </b>
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2700" y="1165" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    layers (n_layers times)...
                </text>
            </switch>
        </g>
        <path d="M 2795 1255 L 2956.13 1255" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2961.38 1255 L 2954.38 1258.5 L 2956.13 1255 L 2954.38 1251.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 2605 1257 L 2572 1257.04 L 2572 1723.05 Q 2572 1727.05 2568 1727.05 L 2210 1727 M 2210 1723 L 2568 1723.05 L 2568 1257.04 Q 2568 1253.05 2571.99 1253.04 L 2605 1253 M 2210 1723" fill="none" stroke="rgb(0, 0, 0)" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 2605 1257 L 2572 1257.04 L 2572 1910 L 2572 1920 M 2568 1920 L 2568 1910 Q 2568 1910 2568 1910 L 2568 1257.04 Q 2568 1253.05 2571.99 1253.04 L 2605 1253 M 2568 1920" fill="none" stroke="#ffffff" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2605" y="1225" width="190" height="60" fill="#ffcce6" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 188px; height: 1px; padding-top: 1255px; margin-left: 2606px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <span style="background-color: rgb(255, 255, 153);">
                                    <b>
                                        RMSNorm
                                    </b>
                                    <br/>
                                </span>
                                <i>
                                    (vocab_size, dim)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2700" y="1260" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    RMSNorm...
                </text>
            </switch>
        </g>
        <path d="M 2795 1360 L 2883.63 1360" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2888.88 1360 L 2881.88 1363.5 L 2883.63 1360 L 2881.88 1356.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2605" y="1330" width="190" height="60" fill="#ffcce6" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 188px; height: 1px; padding-top: 1360px; margin-left: 2606px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                output  - linear
                                <br/>
                                <i>
                                    (dim, vocab_size)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2700" y="1365" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    output  - linear...
                </text>
            </switch>
        </g>
        <path d="M 2840 1060 L 2903.63 1060" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2908.88 1060 L 2901.88 1063.5 L 2903.63 1060 L 2901.88 1056.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 2470 1022.5 L 2322.22 625.97" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2320.39 621.05 L 2326.11 626.38 L 2322.22 625.97 L 2319.56 628.83 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2470" y="1022.5" width="370" height="75" fill="#ffcce6" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 368px; height: 1px; padding-top: 1060px; margin-left: 2471px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                freqs_complex
                                <br/>
                                <b>
                                    precompute_theta_pos_frequencies
                                </b>
                                <br/>
                                <i>
                                    (seq_len, head_dim/2)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2655" y="1065" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    freqs_complex...
                </text>
            </switch>
        </g>
        <path d="M 3060 990 L 3060 1023.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3060 1028.88 L 3056.5 1021.88 L 3060 1023.63 L 3063.5 1021.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2910" y="930" width="300" height="60" fill="#99ffff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 298px; height: 1px; padding-top: 960px; margin-left: 2911px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                h = tok_embeddings(tokens)
                                <br/>
                                <i>
                                    (B, 1) -&gt; (B, 1, dim)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="965" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    h = tok_embeddings(tokens)...
                </text>
            </switch>
        </g>
        <path d="M 3381 0 L 3471 0 L 3491 30 L 3471 60 L 3381 60 L 3361 30 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 30px; margin-left: 3362px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        Big module
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3426" y="34" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Big module
                </text>
            </switch>
        </g>
        <rect x="3511" y="5" width="130" height="50" fill="#ffcce6" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 30px; margin-left: 3512px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                Init
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3576" y="35" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    Init
                </text>
            </switch>
        </g>
        <rect x="3671" y="15" width="110" height="30" fill="#99ffff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 108px; height: 1px; padding-top: 30px; margin-left: 3672px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                forward
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3726" y="35" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    forward
                </text>
            </switch>
        </g>
        <path d="M 4050 480 L 3956.37 480" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3951.12 480 L 3958.12 476.5 L 3956.37 480 L 3958.12 483.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 3845 510 L 3845 543.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3845 548.88 L 3841.5 541.88 L 3845 543.63 L 3848.5 541.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 3740 480 L 3155.9 717.6" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3151.04 719.58 L 3156.2 713.7 L 3155.9 717.6 L 3158.84 720.18 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 610px; margin-left: 3414px;">
                        <div data-drawio-colors="color: #1A1A1A; background-color: rgb(255, 255, 255); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; background-color: rgb(255, 255, 255); white-space: nowrap;">
                                <span style="background-color: rgb(230, 230, 230);">
                                    <font style="font-size: 24px;">
                                        model_args
                                    </font>
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3414" y="615" fill="#1A1A1A" font-family="Helvetica" font-size="14px" text-anchor="middle">
                    model_args
                </text>
            </switch>
        </g>
        <rect x="3740" y="450" width="210" height="60" fill="#647687" stroke="#314354" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 480px; margin-left: 3741px;">
                        <div data-drawio-colors="color: #ffffff; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    LLaMA.build()
                                    <br/>
                                    <b>
                                        <i>
                                            Model = Transformer(model_args)
                                        </i>
                                    </b>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="484" fill="#ffffff" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    LLaMA.build()...
                </text>
            </switch>
        </g>
        <rect x="4050" y="450" width="220" height="60" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 218px; height: 1px; padding-top: 480px; margin-left: 4051px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    Load weights using
                                    <i>
                                        <br/>
                                        <b>
                                            model.load_state_dict(checkpoint)
                                        </b>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4160" y="484" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Load weights using...
                </text>
            </switch>
        </g>
        <path d="M 3845 610 L 3845 643.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3845 648.88 L 3841.5 641.88 L 3845 643.63 L 3848.5 641.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="3740" y="550" width="210" height="60" fill="#647687" stroke="#314354" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 580px; margin-left: 3741px;">
                        <div data-drawio-colors="color: #ffffff; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(255, 255, 255); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <b>
                                        <i>
                                            Model.text_completion(prompts)
                                        </i>
                                    </b>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="584" fill="#ffffff" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Model.text_completion(prompts)
                </text>
            </switch>
        </g>
        <path d="M 3845 710 L 3845 743.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3845 748.88 L 3841.5 741.88 L 3845 743.63 L 3848.5 741.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="3740" y="650" width="210" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 680px; margin-left: 3741px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <i style="">
                                        prompts --&gt; prompt tokens
                                        <br/>
                                        <b>
                                            tokenizer_encode
                                        </b>
                                        <br/>
                                        add bos, not add eos
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="684" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    prompts --&gt; prompt tokens...
                </text>
            </switch>
        </g>
        <path d="M 3880 300 L 4020 300 L 4040 350 L 4020 400 L 3880 400 L 3860 350 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 350px; margin-left: 3861px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font style="font-size: 18px;">
                                    <b>
                                        LLaMA
                                    </b>
                                    <br/>
                                    class for inference
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3950" y="354" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    LLaMA...
                </text>
            </switch>
        </g>
        <path d="M 4040 680 L 3956.37 680" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3951.12 680 L 3958.12 676.5 L 3956.37 680 L 3958.12 683.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="4040" y="650" width="220" height="60" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 218px; height: 1px; padding-top: 680px; margin-left: 4041px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    checks on
                                    <br/>
                                    batch_size, max_prompt_len
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4150" y="684" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    checks on...
                </text>
            </switch>
        </g>
        <path d="M 3845 810 L 3845 833.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3845 838.88 L 3841.5 831.88 L 3845 833.63 L 3848.5 831.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="3740" y="750" width="210" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 780px; margin-left: 3741px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <i style="">
                                        tokens = (batch_size, total_len)
                                        <br/>
                                        Pad tokens at leftover places
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="784" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    tokens = (batch_size, total_len)...
                </text>
            </switch>
        </g>
        <path d="M 4040 780 L 3956.37 780" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3951.12 780 L 3958.12 776.5 L 3956.37 780 L 3958.12 783.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="4040" y="750" width="220" height="60" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 218px; height: 1px; padding-top: 780px; margin-left: 4041px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    No unncessary compute
                                    <br/>
                                    <b>
                                        total_len = min(max_seq_len,
                                        <br/>
                                        max_gen_len + max_prompt_len)
                                    </b>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4150" y="784" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    No unncessary compute...
                </text>
            </switch>
        </g>
        <path d="M 3845 920 L 3845 963.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3845 968.88 L 3841.5 961.88 L 3845 963.63 L 3848.5 961.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 3720 880 L 3211.33 820.74" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3206.11 820.13 L 3213.47 817.46 L 3211.33 820.74 L 3212.66 824.42 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="3720" y="840" width="250" height="80" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 248px; height: 1px; padding-top: 880px; margin-left: 3721px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i style="">
                                    <font color="#0000cc">
                                        logits
                                    </font>
                                    <font color="#1a1a1a">
                                        =
                                        <b>
                                            model.forward
                                        </b>
                                        (
                                    </font>
                                    <br/>
                                    <font color="#1a1a1a">
                                        tokens = tokens[:, cur_pos-1:cur_pos], start_idx = cur_pos)
                                    </font>
                                    <br/>
                                    <br/>
                                </i>
                                <b>
                                    <font color="#0000cc">
                                        logits shape: (batch_size, 1, vocab_size)
                                    </font>
                                </b>
                                <font color="#1a1a1a">
                                    <i style="">
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="884" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    logits = model.forward(...
                </text>
            </switch>
        </g>
        <path d="M 4040 880 L 3976.37 880" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3971.12 880 L 3978.12 876.5 L 3976.37 880 L 3978.12 883.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="4040" y="850" width="220" height="60" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 218px; height: 1px; padding-top: 880px; margin-left: 4041px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    Generate 1 token at a time
                                    <br/>
                                    <b>
                                        for cur_pos in range(1, total_len):
                                    </b>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4150" y="884" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Generate 1 token at a time...
                </text>
            </switch>
        </g>
        <path d="M 3845 1030 L 3845 1093.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3845 1098.88 L 3841.5 1091.88 L 3845 1093.63 L 3848.5 1091.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 3970 970 L 4002 946 Q 4010 940 4019.98 939.41 L 4340.02 920.59 Q 4350 920 4353.16 910.51 L 4367.99 866.04" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 4369.65 861.06 L 4370.75 868.81 L 4367.99 866.04 L 4364.11 866.59 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="3720" y="970" width="250" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 248px; height: 1px; padding-top: 1000px; margin-left: 3721px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i style="">
                                    <font color="#1a1a1a">
                                        probs = softmax(logits[:, -1] / temperature)
                                    </font>
                                    <br/>
                                    <b style="">
                                        <font color="#1a1a1a">
                                            next_token =
                                        </font>
                                        <font color="#006633">
                                            _sample_top_p
                                        </font>
                                        <font color="#1a1a1a">
                                            (probs)
                                        </font>
                                        <br/>
                                    </b>
                                </i>
                                <b>
                                    <font color="#0000cc">
                                        <br/>
                                        shape: (batch_size, )
                                    </font>
                                </b>
                                <font color="#1a1a1a">
                                    <i style="">
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="1004" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    probs = softmax(logits[:, -1] / temperatu...
                </text>
            </switch>
        </g>
        <path d="M 4040 1000 L 3976.37 1000" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3971.12 1000 L 3978.12 996.5 L 3976.37 1000 L 3978.12 1003.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="4040" y="950" width="220" height="100" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 218px; height: 1px; padding-top: 1000px; margin-left: 4041px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <b>
                                        logits[:, -1] --&gt; along vocab dim
                                        <br/>
                                        (for all in batch)
                                    </b>
                                    <br/>
                                    We take argmax directly (greedy) if temperature not given
                                    <br/>
                                    <i>
                                        next_token = argmax(...)
                                    </i>
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4150" y="1004" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    logits[:, -1] --&gt; along vocab dim...
                </text>
            </switch>
        </g>
        <path d="M 4270 950 L 4290 970 L 4270 990 L 4250 970 Z" fill="#cc0000" stroke="none" pointer-events="all"/>
        <rect x="3720" y="1100" width="250" height="60" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 248px; height: 1px; padding-top: 1130px; margin-left: 3721px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a" style="font-weight: bold;">
                                    <i>
                                        tokens[:, cur_pos] = next_token
                                    </i>
                                </font>
                                <br/>
                                <font color="#1a1a1a" style="">
                                    shape: (batch_size, total_len)
                                </font>
                                <font color="#1a1a1a">
                                    <i style="">
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="1134" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    tokens[:, cur_pos] = next_token...
                </text>
            </switch>
        </g>
        <path d="M 4040 1130 L 3976.37 1130" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3971.12 1130 L 3978.12 1126.5 L 3976.37 1130 L 3978.12 1133.5 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="4040" y="1090" width="220" height="80" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 218px; height: 1px; padding-top: 1130px; margin-left: 4041px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <b>
                                        next_token =
                                        <br/>
                                        actual token if mask == 1
                                        <br/>
                                    </b>
                                    predicted token if mask == 0
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4150" y="1134" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    next_token =...
                </text>
            </switch>
        </g>
        <rect x="3720" y="1210" width="250" height="70" fill="#d5e8d4" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 248px; height: 1px; padding-top: 1245px; margin-left: 3721px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i style="color: rgb(26, 26, 26);">
                                    <b>
                                        out_tokens = [B lists]
                                        <br/>
                                        out_text = [B lists]
                                    </b>
                                </i>
                                <font color="#1a1a1a">
                                    <i style="">
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3845" y="1249" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    out_tokens = [B lists]...
                </text>
            </switch>
        </g>
        <rect x="4040" y="1200" width="270" height="80" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 268px; height: 1px; padding-top: 1240px; margin-left: 4041px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <i>
                                        EOS_reached for any sentence iff we generated EOS token for a padding position
                                        <br/>
                                    </i>
                                    <br/>
                                </font>
                                <i style="color: rgb(26, 26, 26);">
                                    break token-wise generation if  eos_reached for all in batch
                                    <br/>
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4175" y="1244" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    EOS_reached for any sentence iff we generated...
                </text>
            </switch>
        </g>
        <rect x="4370" y="830" width="130" height="30" fill="#66ff66" stroke="#82b366" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 128px; height: 1px; padding-top: 845px; margin-left: 4371px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i style="">
                                    <b style="">
                                        <font color="#1a1a1a">
                                            _sample_top_p
                                        </font>
                                    </b>
                                </i>
                                <font color="#1a1a1a">
                                    <i style="">
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="4435" y="849" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    _sample_top_p
                </text>
            </switch>
        </g>
        <path d="M 3060 900 L 3060 923.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3060 928.88 L 3056.5 921.88 L 3060 923.63 L 3063.5 921.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2915" y="820" width="290" height="80" fill="#66ffff" stroke="#1a1a1a" pointer-events="all"/>
        <path d="M 2944 820 L 2944 900 M 3176 820 L 3176 900" fill="none" stroke="#1a1a1a" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 230px; height: 1px; padding-top: 860px; margin-left: 2945px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <i style="">
                                        <font style="font-size: 14px;">
                                            Forward method
                                            <br/>
                                            <b>
                                                tokens: tensor = (B, seq_len = 1), start_idx: int
                                            </b>
                                        </font>
                                        <br/>
                                    </i>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="864" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Forward method...
                </text>
            </switch>
        </g>
        <path d="M 2580 900 L 2600 840 L 2790 840 L 2770 900 Z" fill="#e6e6e6" stroke="#1a1a1a" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 870px; margin-left: 2581px;">
                        <div data-drawio-colors="color: #1A1A1A; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                Note how all of them can be
                                <b>
                                    computed by model_args only
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2685" y="874" fill="#1A1A1A" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Note how all of them can be compute...
                </text>
            </switch>
        </g>
        <path d="M 3060 1090 L 3060 1123.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3060 1128.88 L 3056.5 1121.88 L 3060 1123.63 L 3063.5 1121.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2910" y="1030" width="300" height="60" fill="#99ffff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 298px; height: 1px; padding-top: 1060px; margin-left: 2911px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i>
                                    get freqs_complex for this position
                                    <br/>
                                </i>
                                [start_idx: start_idx + 1]
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="1065" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    get freqs_complex for this positi...
                </text>
            </switch>
        </g>
        <path d="M 3060 1190 L 3060 1223.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3060 1228.88 L 3056.5 1221.88 L 3060 1223.63 L 3063.5 1221.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2885" y="1130" width="350" height="60" fill="#99ffff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 348px; height: 1px; padding-top: 1160px; margin-left: 2886px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i>
                                    h = layer(h, start_idx, freqs_complex)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="1165" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    h = layer(h, start_idx, freqs_complex)
                </text>
            </switch>
        </g>
        <path d="M 3060 1280 L 3060 1313.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3060 1318.88 L 3056.5 1311.88 L 3060 1313.63 L 3063.5 1311.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2962.5" y="1230" width="195" height="50" fill="#99ffff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 193px; height: 1px; padding-top: 1255px; margin-left: 2964px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i>
                                    h = norm(h)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="1260" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    h = norm(h)
                </text>
            </switch>
        </g>
        <path d="M 3230 1320 L 3715.07 924.03" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 3719.13 920.71 L 3715.92 927.84 L 3715.07 924.03 L 3711.5 922.42 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="2890" y="1320" width="340" height="80" fill="#99ffff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 338px; height: 1px; padding-top: 1360px; margin-left: 2891px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i>
                                    h = output_layer(h)
                                    <br/>
                                    <b>
                                        (B, 1, dim) -&gt; (B, 1, vocab_size)
                                    </b>
                                    <br/>
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3060" y="1365" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    h = output_layer(h)...
                </text>
            </switch>
        </g>
        <rect x="1950" y="620" width="370" height="75" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 368px; height: 1px; padding-top: 658px; margin-left: 1951px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    precompute_theta_pos_frequencies
                                </b>
                                <br/>
                                <i>
                                    (head_dim = dim // n_heads,
                                    <br/>
                                    <b>
                                        seq_len = max_seq_len *2 )
                                    </b>
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="663" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    precompute_theta_pos_frequencies...
                </text>
            </switch>
        </g>
        <rect x="1950" y="715" width="370" height="75" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 368px; height: 1px; padding-top: 753px; margin-left: 1951px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    theta_i
                                </b>
                                = 10000 ^ (-2 *(i-1) / dim)
                                <br/>
                                <i>
                                    i = [1, 2, ... , dim/2]
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="758" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    theta_i = 10000 ^ (-2 *(i-1) / dim)...
                </text>
            </switch>
        </g>
        <rect x="1950" y="810" width="370" height="75" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 368px; height: 1px; padding-top: 848px; margin-left: 1951px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    theta
                                </b>
                                = theta_1, theta_2, ..., theta_(dim/2)
                                <br/>
                                <i style="">
                                    <b>
                                        shape: (head_dim / 2)
                                    </b>
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="853" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    theta = theta_1, theta_2, ..., theta_(dim...
                </text>
            </switch>
        </g>
        <path d="M 3263.75 892.5 L 3307.5 936.25 L 3263.75 980 L 3220 936.25 Z" fill="#cc0000" stroke="none" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 86px; height: 1px; padding-top: 936px; margin-left: 3221px;">
                        <div data-drawio-colors="color: #1A1A1A; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font color="#e6e6e6">
                                        seq_len = 1
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="3264" y="940" fill="#1A1A1A" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    seq_len = 1
                </text>
            </switch>
        </g>
        <rect x="1950" y="905" width="370" height="75" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 368px; height: 1px; padding-top: 943px; margin-left: 1951px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    m
                                </b>
                                = arange(seq_len)
                                <br/>
                                <i style="font-weight: bold;">
                                    shape: (seq_len)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="948" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    m = arange(seq_len)...
                </text>
            </switch>
        </g>
        <rect x="1920" y="1000" width="430" height="75" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 428px; height: 1px; padding-top: 1038px; margin-left: 1921px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    freqs
                                </b>
                                = torch.outer(m, theta)
                                <br/>
                                <i style="font-weight: bold;">
                                    seq_len (*) head_dim/2 -&gt; (seq_len, head_dim/2)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="1043" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    freqs = torch.outer(m, theta)...
                </text>
            </switch>
        </g>
        <path d="M 2350 1170 L 2464.55 1100.79" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2469.04 1098.08 L 2464.86 1104.69 L 2464.55 1100.79 L 2461.24 1098.7 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="1920" y="1095" width="430" height="75" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 428px; height: 1px; padding-top: 1133px; margin-left: 1921px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    freqs_complex
                                </b>
                                = torch.polar(
                                <br/>
                                abs = ones_like(freqs), angle = freqs)
                                <br/>
                                <i style="font-weight: bold;">
                                    (seq_len, head_dim/2)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="1138" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    freqs_complex = torch.polar(...
                </text>
            </switch>
        </g>
        <rect x="1960" y="1190" width="350" height="50" fill="#ffe6cc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 348px; height: 1px; padding-top: 1215px; margin-left: 1961px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i>
                                    have **precomputed** freqs_complex
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2135" y="1220" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    have **precomputed** freqs_complex
                </text>
            </switch>
        </g>
        <path d="M 2010 1640 L 2010 1683.63" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2010 1688.88 L 2006.5 1681.88 L 2010 1683.63 L 2013.5 1681.88 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="1840" y="1560" width="340" height="80" fill="#cc99ff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 338px; height: 1px; padding-top: 1600px; margin-left: 1841px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <i>
                                    x: (B, 1, dim)
                                    <br/>
                                    start_pos = int
                                    <br/>
                                    freqs_complex: (seq_len, head_dim/2)
                                </i>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2010" y="1605" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    x: (B, 1, dim)...
                </text>
            </switch>
        </g>
        <path d="M 2010 1760 L 2010 1803.63" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2010 1808.88 L 2006.5 1801.88 L 2010 1803.63 L 2013.5 1801.88 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 1810 1690 L 1284.7 1209.3" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 1280.82 1205.75 L 1288.35 1207.9 L 1284.7 1209.3 L 1283.63 1213.06 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1414px; margin-left: 1508px;">
                        <div data-drawio-colors="color: #1A1A1A; background-color: rgb(255, 255, 255); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 14px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; background-color: rgb(255, 255, 255); white-space: nowrap;">
                                <span style="background-color: rgb(240, 240, 240);">
                                    forward method
                                    <i>
                                        <b>
                                            (x, start_pos, freqs_complex)
                                        </b>
                                    </i>
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1508" y="1418" fill="#1A1A1A" font-family="Helvetica" font-size="14px" text-anchor="middle">
                    forward method (x, start_pos, freqs_complex)
                </text>
            </switch>
        </g>
        <rect x="1810" y="1690" width="400" height="70" fill="#cc99ff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 398px; height: 1px; padding-top: 1725px; margin-left: 1811px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                h = x + attn.forward(
                                <br/>
                                <span style="background-color: rgb(255, 255, 153);">
                                    attention_norm(x)
                                </span>
                                , start_pos, freqs_complex)
                                <br/>
                                <b>
                                    <i>
                                        (B, 1, dim)
                                    </i>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2010" y="1730" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    h = x + attn.forward(...
                </text>
            </switch>
        </g>
        <path d="M 2210 1843 L 2568 1843.05 L 2568 1257.04 Q 2568 1253.05 2571.99 1253.04 L 2605 1253 M 2605 1257 L 2572 1257.04 L 2572 1843.05 Q 2572 1847.05 2568 1847.05 L 2210 1847 M 2605 1257" fill="none" stroke="rgb(0, 0, 0)" stroke-linejoin="round" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 1px; height: 1px; padding-top: 1610px; margin-left: 2560px;">
                        <div data-drawio-colors="color: #1A1A1A; background-color: rgb(255, 255, 255); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 24px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; background-color: rgb(255, 255, 255); white-space: nowrap;">
                                <span style="background-color: rgb(255, 255, 153);">
                                    highlighted are RMSNorms
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2560" y="1617" fill="#1A1A1A" font-family="Helvetica" font-size="24px" text-anchor="middle">
                    highlighted are RMSNorms
                </text>
            </switch>
        </g>
        <path d="M 2010 1880 L 2010 1950 Q 2010 1960 2020 1960 L 2190 1960 Q 2200 1960 2204.33 1950.99 L 2567.24 1195.74" fill="none" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 2569.52 1191.01 L 2569.64 1198.83 L 2567.24 1195.74 L 2563.33 1195.8 Z" fill="rgb(0, 0, 0)" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="1810" y="1810" width="400" height="70" fill="#cc99ff" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 398px; height: 1px; padding-top: 1845px; margin-left: 1811px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                out = h + feed_forward(
                                <span style="background-color: rgb(255, 255, 153);">
                                    ffn_norm
                                </span>
                                (h))
                                <br/>
                                <b>
                                    <i>
                                        (B, 1, dim)
                                    </i>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2010" y="1850" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    out = h + feed_forward(ffn_norm(h))...
                </text>
            </switch>
        </g>
        <path d="M 1860 1440 L 2000 1440 L 2020 1490 L 2000 1540 L 1860 1540 L 1840 1490 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 1490px; margin-left: 1841px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        EncoderBlock
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1930" y="1494" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    EncoderBlock
                </text>
            </switch>
        </g>
        <path d="M 2500 1920 L 2640 1920 L 2660 1970 L 2640 2020 L 2500 2020 L 2480 1970 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 1970px; margin-left: 2481px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        RMSNorm
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2570" y="1974" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    RMSNorm
                </text>
            </switch>
        </g>
        <rect x="2365" y="2040" width="410" height="110" fill="#ffff99" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 408px; height: 1px; padding-top: 2095px; margin-left: 2366px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <span style="background-color: rgb(255, 255, 153);">
                                    _norm = x * torch.rsqrt (
                                    <br/>
                                    x.pow(2).mean(-1, keepdim=True) + eps)
                                    <br/>
                                    <b>
                                        <i>
                                            (B, 1, dim) * (B, 1, 1) -&gt; (B, 1, dim) (broadcasting!)
                                        </i>
                                    </b>
                                    <br/>
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2570" y="2100" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    _norm = x * torch.rsqrt (...
                </text>
            </switch>
        </g>
        <path d="M 2830 2040 L 2850 2000 L 3040 2000 L 3020 2040 Z" fill="#e6e6e6" stroke="#1a1a1a" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 208px; height: 1px; padding-top: 2020px; margin-left: 2831px;">
                        <div data-drawio-colors="color: #1A1A1A; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                rsqrt --&gt; reciprocal sqrt
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2935" y="2024" fill="#1A1A1A" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    rsqrt --&gt; reciprocal sqrt
                </text>
            </switch>
        </g>
        <path d="M 2810 2140 L 2830 2070 L 3150 2070 L 3130 2140 Z" fill="#e6e6e6" stroke="#1a1a1a" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 338px; height: 1px; padding-top: 2105px; margin-left: 2811px;">
                        <div data-drawio-colors="color: #1A1A1A; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <div>
                                    x.pow(2): (B, seq_len, dim)
                                </div>
                                <div>
                                    <span style="background-color: initial;">
                                        x.pow(2).mean(-1) : (B, seq_len)
                                    </span>
                                </div>
                                <div>
                                    <span style="background-color: initial;">
                                        x.pow(2).mean(-1, keepdim = True) : (B, seq_len, 1)
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2980" y="2109" fill="#1A1A1A" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    x.pow(2): (B, seq_len, dim)...
                </text>
            </switch>
        </g>
        <rect x="2365" y="2180" width="410" height="80" fill="#ffff99" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 408px; height: 1px; padding-top: 2220px; margin-left: 2366px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <span style="background-color: rgb(255, 255, 153);">
                                    return gamma * _norm(x.float())
                                    <br/>
                                    <b>
                                        <i>
                                            (dim) * (B, 1, dim) -&gt; (B, 1, dim)
                                        </i>
                                    </b>
                                    <br/>
                                </span>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2570" y="2225" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    return gamma * _norm(x.float())...
                </text>
            </switch>
        </g>
        <path d="M 2810 2240 L 2830 2200 L 3100 2200 L 3080 2240 Z" fill="#e6e6e6" stroke="#1a1a1a" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 288px; height: 1px; padding-top: 2220px; margin-left: 2811px;">
                        <div data-drawio-colors="color: #1A1A1A; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                gamma = nn.Parameter(torch.ones(dim)
                                <br/>
                                <b>
                                    <i>
                                        learnable xD
                                    </i>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="2955" y="2224" fill="#1A1A1A" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    gamma = nn.Parameter(torch.ones(dim)...
                </text>
            </switch>
        </g>
        <path d="M 1050 1250 L 1050 1313.63" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 1050 1318.88 L 1046.5 1311.88 L 1050 1313.63 L 1053.5 1311.88 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="820" y="1160" width="460" height="90" fill="#ffcccc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 458px; height: 1px; padding-top: 1205px; margin-left: 821px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    xq
                                </b>
                                = self.wq(x)
                                <br/>
                                <b>
                                    xk
                                </b>
                                = self.wk(x)
                                <br/>
                                <b>
                                    xv
                                </b>
                                = self.wv(x)
                                <br/>
                                <b>
                                    <i>
                                        (B, 1, dim) -&gt; (B, 1, n_heads_(q/kv) * head_dim)
                                    </i>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1050" y="1210" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    xq = self.wq(x)...
                </text>
            </switch>
        </g>
        <path d="M 740 1205 L 813.63 1205" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 818.88 1205 L 811.88 1208.5 L 813.63 1205 L 811.88 1201.5 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="440" y="1178.75" width="300" height="52.5" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 298px; height: 1px; padding-top: 1205px; margin-left: 441px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    self.wq = nn.Linear(dim,
                                    <b>
                                        n_heads_q *
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        head_dim
                                    </b>
                                </span>
                                <font color="#1a1a1a">
                                    )
                                    <br/>
                                </font>
                                <font color="#1a1a1a">
                                    self.wk = nn.Linear(dim,
                                    <b>
                                        n_heads_kv *
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        head_dim
                                    </b>
                                </span>
                                <font color="#1a1a1a">
                                    )
                                </font>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                                <font color="#1a1a1a">
                                    self.wv = nn.Linear(dim,
                                    <b>
                                        n_heads_kv *
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        head_dim
                                    </b>
                                </span>
                                <font color="#1a1a1a">
                                    )
                                </font>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="590" y="1209" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    self.wq = nn.Linear(dim, n_heads_q * head_dim)...
                </text>
            </switch>
        </g>
        <path d="M 1050 1400 L 1050 1453.63" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 1050 1458.88 L 1046.5 1451.88 L 1050 1453.63 L 1053.5 1451.88 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="820" y="1320" width="460" height="80" fill="#ffcccc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 458px; height: 1px; padding-top: 1360px; margin-left: 821px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                xq = xq.
                                <b>
                                    view
                                </b>
                                (B, 1, n_heads_q, head_dim)
                                <br/>
                                Similarly xk, xv
                                <br/>
                                <b>
                                    <i>
                                        (B, 1, n_heads_(q/kv), head_dim)
                                    </i>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1050" y="1365" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    xq = xq.view(B, 1, n_heads_q, head_dim)...
                </text>
            </switch>
        </g>
        <rect x="820" y="1460" width="460" height="80" fill="#ffcccc" stroke="rgb(0, 0, 0)" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 458px; height: 1px; padding-top: 1500px; margin-left: 821px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 18px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                xq =
                                <b>
                                    apply_rope
                                </b>
                                (xq, freqs_complex)
                                <br/>
                                xk = apply_rope(xk, freqs_complex)
                                <br/>
                                <b>
                                    <i>
                                        (B, 1, n_heads_(q/kv), head_dim)
                                    </i>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1050" y="1505" fill="#000000" font-family="Helvetica" font-size="18px" text-anchor="middle">
                    xq = apply_rope(xq, freqs_complex)...
                </text>
            </switch>
        </g>
        <path d="M 740 1500 L 813.63 1500" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 818.88 1500 L 811.88 1503.5 L 813.63 1500 L 811.88 1496.5 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <path d="M 440 1473.75 L 362.14 1256" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 360.38 1251.05 L 366.03 1256.47 L 362.14 1256 L 359.44 1258.82 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="440" y="1473.75" width="300" height="52.5" fill="#fad7ac" stroke="#b46504" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 298px; height: 1px; padding-top: 1500px; margin-left: 441px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    <b>
                                        Multiple transformations
                                    </b>
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="590" y="1504" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    Multiple transformations
                </text>
            </switch>
        </g>
        <path d="M 1300 1530 L 1320 1490 L 1470 1490 L 1450 1530 Z" fill="#e6e6e6" stroke="#1a1a1a" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 168px; height: 1px; padding-top: 1510px; margin-left: 1301px;">
                        <div data-drawio-colors="color: #1A1A1A; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(26, 26, 26); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                RoPE only to xq, xk
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1385" y="1514" fill="#1A1A1A" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    RoPE only to xq, xk
                </text>
            </switch>
        </g>
        <path d="M 180 1302.5 L 180 1323.63" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 180 1328.88 L 176.5 1321.88 L 180 1323.63 L 183.5 1321.88 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="0" y="1250" width="360" height="52.5" fill="#ccffe6" stroke="#3333ff" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 1276px; margin-left: 1px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    x = x.reshape(*x.shape[:-1], -1,2)
                                    <br/>
                                    <b>
                                        (B, 1, n_heads, head_dim) -&gt;
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        (B, 1, n_heads, head_dim/2, 2)
                                    </b>
                                </span>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="180" y="1280" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    x = x.reshape(*x.shape[:-1], -1,2)...
                </text>
            </switch>
        </g>
        <path d="M 180 1382.5 L 180 1416.13" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 180 1421.38 L 176.5 1414.38 L 180 1416.13 L 183.5 1414.38 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="0" y="1330" width="360" height="52.5" fill="#ccffe6" stroke="#3333ff" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 1356px; margin-left: 1px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    x_complex = torch.view_as_complex(x)
                                    <br/>
                                    <b>
                                        (B, 1, n_heads, head_dim/2, 2) -&gt;
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        (B, 1, n_heads, head_dim/2)
                                    </b>
                                </span>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="180" y="1360" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    x_complex = torch.view_as_complex(x)...
                </text>
            </switch>
        </g>
        <path d="M 180 1492.5 L 180 1516.13" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 180 1521.38 L 176.5 1514.38 L 180 1516.13 L 183.5 1514.38 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="0" y="1422.5" width="360" height="70" fill="#ccffe6" stroke="#3333ff" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 1458px; margin-left: 1px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    freqs_complex =
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    freqs_complex.unsqueeze(0).unsqueeze(2)
                                </span>
                                <font color="#1a1a1a">
                                    <br/>
                                    <b>
                                        (seq_len, head_dim/2) -&gt;
                                        <br/>
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        (1, seq_len, head_dim/2) -&gt;
                                    </b>
                                </span>
                                <b style="color: rgb(26, 26, 26);">
                                    <br/>
                                </b>
                                <b style="color: rgb(26, 26, 26);">
                                    (1, seq_len, 1, head_dim/2)
                                </b>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="180" y="1461" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    freqs_complex = freqs_complex.unsqueeze(0).unsqueeze(2)...
                </text>
            </switch>
        </g>
        <path d="M 180 1592.5 L 180 1616.13" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 180 1621.38 L 176.5 1614.38 L 180 1616.13 L 183.5 1614.38 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="0" y="1522.5" width="360" height="70" fill="#ccffe6" stroke="#3333ff" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 1558px; margin-left: 1px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    x_rotated = x_complex * freqs_complex
                                </font>
                                <font color="#1a1a1a">
                                    <br/>
                                    <b>
                                        (B, 1, n_heads, head_dim/2) *
                                    </b>
                                </font>
                                <b style="color: rgb(26, 26, 26);">
                                    (1, seq_len, 1, head_dim/2) -&gt;
                                </b>
                                <font color="#1a1a1a">
                                    <b>
                                        <br/>
                                    </b>
                                </font>
                                <span style="color: rgb(26, 26, 26);">
                                    <b>
                                        (B, seq_len, n_heads, head_dim/2)
                                    </b>
                                </span>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="180" y="1561" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    x_rotated = x_complex * freqs_complex...
                </text>
            </switch>
        </g>
        <path d="M 180 1692.5 L 180 1716.13" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 180 1721.38 L 176.5 1714.38 L 180 1716.13 L 183.5 1714.38 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="0" y="1622.5" width="360" height="70" fill="#ccffe6" stroke="#3333ff" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 1658px; margin-left: 1px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    x_out = torch.view_as_real(x_rotated)
                                </font>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                                <b style="color: rgb(26, 26, 26);">
                                    (B, seq_len, n_heads, head_dim/2) -&gt;
                                    <br/>
                                </b>
                                <b style="color: rgb(26, 26, 26);">
                                    (B, seq_len, n_heads, head_dim/2, 2)
                                </b>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="180" y="1661" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    x_out = torch.view_as_real(x_rotated)(B, seq_len, n_heads, h...
                </text>
            </switch>
        </g>
        <path d="M 360 1792.5 L 438.17 1532.35" fill="none" stroke="#ffffff" stroke-miterlimit="10" pointer-events="stroke"/>
        <path d="M 439.68 1527.32 L 441.02 1535.03 L 438.17 1532.35 L 434.31 1533.02 Z" fill="#ffffff" stroke="#ffffff" stroke-miterlimit="10" pointer-events="all"/>
        <rect x="0" y="1722.5" width="360" height="70" fill="#ccffe6" stroke="#3333ff" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 358px; height: 1px; padding-top: 1758px; margin-left: 1px;">
                        <div data-drawio-colors="color: rgb(0, 0, 0); " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <font color="#1a1a1a">
                                    x_out = x_out.reshape(*x.shape)
                                </font>
                                <b style="color: rgb(26, 26, 26);">
                                    <br/>
                                </b>
                                <b style="color: rgb(26, 26, 26);">
                                    (B, seq_len, n_heads, head_dim)
                                </b>
                                <font color="#1a1a1a">
                                    <br/>
                                </font>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="180" y="1761" fill="rgb(0, 0, 0)" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    x_out = x_out.reshape(*x.shape)(B, seq_len, n_heads, head_di...
                </text>
            </switch>
        </g>
        <path d="M 980 1022.5 L 1120 1022.5 L 1140 1072.5 L 1120 1122.5 L 980 1122.5 L 960 1072.5 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 1073px; margin-left: 961px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        SelfAttention
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="1050" y="1076" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    SelfAttention
                </text>
            </switch>
        </g>
        <path d="M 105 1122.5 L 245 1122.5 L 265 1172.5 L 245 1222.5 L 105 1222.5 L 85 1172.5 Z" fill="#ffff66" stroke="rgb(0, 0, 0)" stroke-miterlimit="10" pointer-events="all"/>
        <g transform="translate(-0.5 -0.5)">
            <switch>
                <foreignObject pointer-events="none" width="100%" height="100%" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility" style="overflow: visible; text-align: left;">
                    <div xmlns="http://www.w3.org/1999/xhtml" style="display: flex; align-items: unsafe center; justify-content: unsafe center; width: 178px; height: 1px; padding-top: 1173px; margin-left: 86px;">
                        <div data-drawio-colors="color: #000000; " style="box-sizing: border-box; font-size: 0px; text-align: center;">
                            <div style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; pointer-events: all; white-space: normal; overflow-wrap: normal;">
                                <b>
                                    <font style="font-size: 18px;">
                                        apply_RoPE
                                    </font>
                                </b>
                            </div>
                        </div>
                    </div>
                </foreignObject>
                <text x="175" y="1176" fill="#000000" font-family="Helvetica" font-size="12px" text-anchor="middle">
                    apply_RoPE
                </text>
            </switch>
        </g>
    </g>
    <switch>
        <g requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"/>
        <a transform="translate(0,-5)" xlink:href="https://www.diagrams.net/doc/faq/svg-export-text-problems" target="_blank">
            <text text-anchor="middle" font-size="10px" x="50%" y="100%">
                Text is not SVG - cannot display
            </text>
        </a>
    </switch>
</svg>